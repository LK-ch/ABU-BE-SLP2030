<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zirkulärer Aufbau von Kompetenzen – EFZ 3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Roboto',-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#000;background:#fff;font-size:15px}

/* ── Header ── */
header{background:#fff;border-bottom:1px solid #e0e0e0;padding:12px 24px 0 24px}
.header-top{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:flex-start}
.logo-section{display:flex;align-items:center;gap:12px;padding-bottom:8px}
.logo-section img{height:60px;width:auto}
.app-title{font-size:1em;font-weight:400;color:#000;padding-bottom:12px}
.service-nav{display:flex;align-items:center;gap:20px;padding-top:4px}
.service-nav a{font-size:.85em;color:#000;text-decoration:none}
.service-nav a:hover{text-decoration:underline}
.language-selector{display:flex;align-items:center;gap:6px;font-size:.85em}
.language-selector span{color:#666}
.language-selector a{color:#000;text-decoration:none}
.language-selector a.active{font-weight:700;border-bottom:2px solid #dc291e;padding-bottom:1px}
.language-selector a:hover{text-decoration:underline}

/* ── Footer ── */
footer{background:#fff;border-top:1px solid #e0e0e0;padding:14px 24px;margin-top:40px}
.footer-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.footer-copyright{font-size:.82em;color:#333}
.footer-links{display:flex;gap:24px}
.footer-links a{font-size:.82em;font-weight:700;color:#000;text-decoration:none}
.footer-links a:hover{text-decoration:underline}

/* ── Container ── */
.container{max-width:1200px;margin:30px auto 0;padding:20px;background:#fff}
.breadcrumb{font-size:.9em;color:#666;margin-bottom:20px}
.breadcrumb a{color:#000;text-decoration:none;font-weight:500}
.breadcrumb a:hover{text-decoration:underline}
h1{color:#000;font-size:2.2em;margin-bottom:10px;font-weight:700;line-height:1.3}
.subtitle{color:#000;font-size:1.1em;margin-bottom:30px;font-weight:300}
.back-btn{background:#fff;border:2px solid #dc291e;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;margin-bottom:1.5rem;transition:all .2s;text-decoration:none;color:#dc291e;font-weight:500;font-size:.9em}
.back-btn:hover{background:#dc291e;color:#fff;transform:translateX(-3px)}

/* ── Info-Box ── */
.status-info{background:#f9f3e8;padding:20px;margin-bottom:25px}
.status-info h2{color:#dc291e;margin-bottom:15px;font-size:1.1em;font-weight:700}
.status-info-header{cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none}
.status-info-toggle{font-size:1em;transition:transform .2s;color:#dc291e;font-weight:bold}
.status-info-toggle.open{transform:rotate(90deg)}
.status-info-content{max-height:0;overflow:hidden;transition:max-height .3s}
.status-info-content.open{max-height:800px}
.status-info ul{list-style:none;padding-left:0;margin-top:15px}
.status-info li{padding:.4rem 0 .4rem 1.5rem;position:relative;font-size:1em}
.status-info li span{position:absolute;left:0;color:#dc291e;font-weight:bold}

/* ── Section title ── */
.section-title{font-size:1.8em;font-weight:700;color:#dc291e;margin:40px 0 20px;padding-bottom:10px;border-bottom:2px solid #dc291e;text-align:center}

/* ── Main filter area ── */
.filter-area{margin:20px 0 25px;}
.main-filter-container{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:0}

/* Main filter buttons */
.main-filter-btn{background:#fff;border:2px solid #ddd;padding:10px 22px;border-radius:4px;cursor:pointer;font-size:1em;font-weight:500;transition:all .2s;color:#333;display:inline-flex;align-items:center;gap:6px}
.main-filter-btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.12)}
.main-filter-btn.active{box-shadow:0 2px 10px rgba(0,0,0,.15)}
.mfb-reset{border-color:#555;color:#555}.mfb-reset.active{background:#555;color:#fff}
.mfb-schluessel{border-color:#dc291e;color:#dc291e}.mfb-schluessel.active{background:#dc291e;color:#fff}
.mfb-gesellschaft{border-color:#ffd966;color:#d4a500}.mfb-gesellschaft.active{background:#ffd966;color:#333}
.mfb-digital{border-color:#4db380;color:#4db380}.mfb-digital.active{background:#4db380;color:#fff}
.mfb-sprache{border-color:#3385d6;color:#3385d6}.mfb-sprache.active{background:#3385d6;color:#fff}
.mfb-sprach-inhalt{border-color:#7b68c4;color:#7b68c4}.mfb-sprach-inhalt.active{background:#7b68c4;color:#fff}

/* Arrow indicator on buttons */
.btn-arrow{font-size:.7em;transition:transform .2s;display:inline-block}
.main-filter-btn.open .btn-arrow{transform:rotate(180deg)}

/* ── Dropdown panel ── */
.filter-dropdown{display:none;background:#fafafa;border:1px solid #e0e0e0;border-radius:6px;padding:16px 20px;margin-top:10px;animation:fadeIn .15s ease}
.filter-dropdown.visible{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

.dropdown-inner{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start}

/* Sprach-Inhalte grouped layout */
.si-group{width:100%;display:flex;flex-direction:column;gap:6px}
.si-group-header{font-size:.8em;font-weight:700;color:#3385d6;padding:4px 0 4px;border-bottom:1px solid #ddd;margin-top:8px}
.si-group-header:first-child{margin-top:0}
.si-group-row{display:flex;flex-wrap:wrap;gap:6px}

/* Norm header */
.si-norm-header{color:#c44500 !important}

/* ── Sub-filter kacheln (inline chips) ── */
.chip{background:#fff;border:1px solid #ddd;padding:6px 14px;border-radius:20px;cursor:pointer;font-size:.85em;font-weight:500;transition:all .15s;white-space:nowrap;color:#444}
.chip:hover{transform:translateY(-1px);box-shadow:0 2px 5px rgba(0,0,0,.1)}
.chip.active{box-shadow:0 1px 5px rgba(0,0,0,.2)}
.chip-schluessel.active{background:#dc291e;color:#fff;border-color:#dc291e}
.chip-gesellschaft.active{background:#ffd966;color:#333;border-color:#d4a500}
.chip-digital.active{background:#4db380;color:#fff;border-color:#4db380}
.chip-sprache.active{background:#3385d6;color:#fff;border-color:#3385d6}
.chip-sprach-inhalt.active{background:#7b68c4;color:#fff;border-color:#7b68c4}

/* ── Timeline ── */
.timeline-grid{display:flex;gap:16px;margin-top:25px;align-items:flex-start}
.year-column{flex:1;background:#fff;border-radius:6px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);min-width:0}
.year-header{background:linear-gradient(135deg,#dc291e,#a00d24);color:#fff;padding:14px;border-radius:4px;margin-bottom:14px;text-align:center}
.year-header h2{font-size:1.3em;margin-bottom:4px;font-weight:700}
.year-header p{font-size:.85em;opacity:.9;font-weight:300}

/* ── Theme cards ── */
.theme-card{background:#fafafa;border-radius:4px;padding:14px;margin-bottom:14px;transition:all .2s}
.theme-card:hover{transform:translateX(2px);box-shadow:0 2px 6px rgba(0,0,0,.08)}
.theme-card h3{color:#dc291e;font-size:1.05em;margin-bottom:10px;font-weight:700;line-height:1.3}
.theme-card.placeholder{opacity:.5}.theme-card.placeholder h3{color:#999}
.theme-card.schlussarbeit{background:#f5e6d3;opacity:.7}.theme-card.schlussarbeit h3{color:#a00d24}

/* ── Lebensbezug items ── */
.lebensbezug-item{background:#fff;padding:8px 10px;margin-bottom:8px;border-radius:3px}
.lebensbezug-label{font-size:.75em;color:#666;text-transform:uppercase;font-weight:500;margin-bottom:3px;display:inline-block;letter-spacing:.3px;cursor:pointer;position:relative;border-bottom:1px dotted #999}
.lebensbezug-label:hover{color:#dc291e;border-bottom-color:#dc291e}

/* ── Badges ── */
.kompetenz-detail{margin-top:8px;font-size:.85em}
.kompetenz-badge{display:inline-block;font-size:.85em;padding:4px 10px;margin:2px 3px 2px 0;border-radius:2px;font-weight:500;position:relative;cursor:pointer;line-height:1}
.badge-gesellschaft{background:rgba(255,217,102,.3)}
.badge-digital{background:rgba(77,179,128,.3)}
.badge-sprache{background:rgba(51,133,214,.3)}
.badge-sprach-inhalt{background:rgba(123,104,196,.25)}

.schluesselkompetenzen{padding:0;margin:10px 0 12px;line-height:1}
.schluesselkompetenz-badge{display:inline-block;background:rgba(220,41,30,.12);padding:4px 10px;margin:2px 3px 2px 0;border-radius:2px;font-size:.85em;font-weight:500;color:#dc291e;position:relative;cursor:pointer;line-height:1}

/* ── Tooltips ── */
.tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:10px 14px;border-radius:4px;font-size:.9em;pointer-events:none;opacity:0;transition:opacity .2s;z-index:1000;margin-bottom:10px;max-width:300px;white-space:normal;text-align:center;line-height:1.5}
.tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:7px solid transparent;border-top-color:rgba(0,0,0,.9)}
.kompetenz-badge:hover .tooltip,.schluesselkompetenz-badge:hover .tooltip,.lebensbezug-label:hover .tooltip{opacity:1}

.loading{text-align:center;padding:40px;color:#dc291e;font-weight:500}

.chip-reset{font-style:italic;opacity:.8;border-style:dashed;width:100%}
.chip-reset:hover{opacity:1}

@media(max-width:1200px){.timeline-grid{flex-direction:column;gap:20px}.year-column{width:100%}}
@media(max-width:768px){body{font-size:14px}h1{font-size:1.8em}.container{padding:15px}.year-header h2{font-size:1.1em}.theme-card h3{font-size:.95em}.main-filter-btn{padding:8px 16px;font-size:.9em}.logo-section img{height:70px}.chip{font-size:.8em;padding:5px 11px}}
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div>
      <div class="logo-section"><img src="../images/KTBE.png" alt="Logo des Kantons Bern"></div>
      <div class="app-title">Schullehrplan ABU / Plan d'études de culture générale</div>
    </div>
    <nav class="service-nav" aria-label="Service-Navigation">
      <a href="../kontakt_de.html">Kontakt</a>
      <div class="language-selector">
        <a href="zirkularitaet_de.html" class="active" lang="de">DE</a>
        <span>|</span>
        <a href="zirkularitaet_fr.html" lang="fr">FR</a>
      </div>
    </nav>
  </div>
</header>

<div class="container">
  <nav class="breadcrumb">
    <a href="../index_de.html">Schullehrplan ABU</a> /
    <a href="index_de.html">3-jährige Grundbildung EFZ</a> /
    Zirkularität
  </nav>

  <h1>Zirkularität im Schullehrplan ABU</h1>
  <p class="subtitle">Spiralförmiger Kompetenzaufbau über die gesamte Lehrzeit</p>

  <a href="index_de.html" class="back-btn">← Zurück zur Übersicht 3-jährige Grundbildung EFZ</a>

  <div class="section-title">Kompetenzaufbau über die Lehrjahre</div>

  <!-- ── Filter area with dropdowns ── -->
  <div class="filter-area">
    <div class="main-filter-container" id="main-filter-btns">
      <button class="main-filter-btn mfb-reset" id="btn-reset" onclick="resetFilter()">Alles anzeigen</button>
      <button class="main-filter-btn mfb-schluessel" id="btn-schluessel" onclick="toggleDropdown('schluessel')">Schlüsselkompetenzen <span class="btn-arrow">▾</span></button>
      <button class="main-filter-btn mfb-gesellschaft" id="btn-gesellschaft" onclick="toggleDropdown('gesellschaft')">Gesellschaft <span class="btn-arrow">▾</span></button>
      <button class="main-filter-btn mfb-digital" id="btn-digital" onclick="toggleDropdown('digital')">Medien und Digitalität <span class="btn-arrow">▾</span></button>
      <button class="main-filter-btn mfb-sprache" id="btn-sprache" onclick="toggleDropdown('sprache')">Sprachtypen <span class="btn-arrow">▾</span></button>
      <button class="main-filter-btn mfb-sprach-inhalt" id="btn-sprach-inhalt" onclick="toggleDropdown('sprach-inhalt')">Sprachinhalte (zirkulär) <span class="btn-arrow">▾</span></button>
    </div>

    <!-- Dropdown panels (one per category, rendered below buttons) -->
    <div class="filter-dropdown" id="dropdown-schluessel"></div>
    <div class="filter-dropdown" id="dropdown-gesellschaft"></div>
    <div class="filter-dropdown" id="dropdown-digital"></div>
    <div class="filter-dropdown" id="dropdown-sprache"></div>
    <div class="filter-dropdown" id="dropdown-sprach-inhalt"></div>
  </div>

  <div id="loading" class="loading">Lade Kompetenzen aus dem Lehrplan...</div>
  <div id="timeline-container" class="timeline-grid" style="display:none;"></div>

  <div class="status-info" style="margin-top:50px;">
    <div class="status-info-header" onclick="toggleStatusInfo()">
      <h2>Vorgaben gemäss Rahmenlehrplan ABU 2025</h2>
      <span class="status-info-toggle">▶</span>
    </div>
    <div class="status-info-content">
      <ul>
        <li><span>▸</span>Pro Thema werden mindestens <strong>3 Schlüsselkompetenzen</strong> bewusst gefördert</li>
        <li><span>▸</span>Lerninhalte aus mindestens <strong>3 Aspekten</strong> des Lernbereichs Gesellschaft</li>
        <li><span>▸</span>Berücksichtigung von <strong>3 Sprachtypen</strong> pro Thema</li>
        <li><span>▸</span>Kompetenzen aus allen <strong>Sprachtypen</strong> unter Berücksichtigung von Konvention, Normen und Sprachbewusstheit</li>
        <li><span>▸</span>Bis zum Abschluss: Aufbau aller <strong>12 Schlüsselkompetenzen</strong> und Kompetenzen aus allen <strong>8 gesellschaftlichen Aspekten</strong></li>
        <li><span>▸</span>Integration der <strong>Schlussarbeit</strong> im letzten Lehrjahr</li>
        <li><span>▸</span>Spiralförmiges Curriculum mit formativen und summativen Kompetenznachweisen</li>
      </ul>
    </div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════
   CONFIG
   ══════════════════════════════════════════ */

const THEMES = [
  { nr: 1, name: 'Meine Berufsausbildung',        file: 'thema1.html', year: 1 },
  { nr: 2, name: 'Geld verdienen und ausgeben',    file: 'thema2.html', year: 1 },
  { nr: 3, name: 'Gesund und sicher durchs Leben', file: 'thema3.html', year: 1 },
  { nr: 4, name: 'Meine Kultur, meine Beziehungen', file: null, year: 2 },
  { nr: 5, name: 'Interessen vertreten',           file: null, year: 2 },
  { nr: 6, name: 'Nachhaltiges Handeln',           file: null, year: 2 },
  { nr: 0, name: 'Schlussarbeit',                  file: null, year: 3, schlussarbeit: true },
  { nr: 7, name: 'Arbeiten im Wandel',             file: null, year: 3 },
  { nr: 8, name: 'Mein Zuhause',                   file: null, year: 3 }
];

const SK = {
  '1.1':'Zwischen relevanten und irrelevanten Quellen und Inhalten unterscheiden',
  '1.2':'Sich selbst Ziele setzen, die Zielsetzung überprüfen und sich adaptiv verhalten',
  '1.3':'Antizipative, unternehmerische und innovative Wege der Problemlösung erkennen, entwickeln und umsetzen',
  '1.4':'In unterschiedlichen Teams zielgerichtet und effizient arbeiten',
  '1.5':'Die eigenen Werthaltungen und Überzeugungen erkennen, verstehen, kritisch reflektieren und weiterentwickeln',
  '1.6':'Die eigenen Standpunkte begründen und andere davon überzeugen',
  '1.7':'Unterschiedliche Standpunkte nachvollziehen und das gegenseitige Verständnis fördern',
  '1.8':'Eigene Lebensphasen planen und mit Unwägbarkeiten umgehen',
  '1.9':'Vernetzt und systemisch denken, um sozial, ökologisch und ökonomisch nachhaltig zu handeln',
  '1.10':'Sich in einem sich ständig verändernden Umfeld zurechtfinden und sich an dieses anpassen',
  '1.11':'Mit Mehrdeutigkeiten umgehen',
  '1.12':'An gesellschaftlichen Prozessen partizipieren und Handlungsspielräume nutzen'
};
const GES = {'2.1':'Ethik','2.2':'Identität und Sozialisation','2.3':'Kultur','2.4':'Ökologie','2.5':'Politik','2.6':'Recht','2.7':'Technologische und digitale Transformation','2.8':'Wirtschaft'};
const DIG = {'3.1':'Grundlagen der Informatik','3.2':'Informations- & Datenkompetenz','3.3':'Inhaltserstellung','3.4':'Problemlösung','3.5':'KI-spezifische Komponenten','3.6':'Ethische & reflektive Haltung'};
const SPR = {'4.1':'Deskriptiv (beschreibend)','4.2':'Expositorisch (erklärend)','4.3':'Argumentativ (überzeugend)','4.4':'Diskursiv (interagierend)','4.5':'Reflexiv (reflektierend)'};

const SPRACH_INHALTE = {
  '4.1': [
    {id:'si-praesentieren',  label:'Präsentieren'},
    {id:'si-loesungsansaetze',label:'Lösungsansätze beschreiben'},
    {id:'si-infos-vertrag',  label:'Informationen (aus einem Vertrag) herauslesen'},
    {id:'si-aussagen',       label:'Aussagen (aus Hörtexten/Videos) erfassen'},
    {id:'si-recherche',      label:'Rechercheergebnisse vermitteln'},
    {id:'si-geschaeftsbrief',label:'Geschäftsbrief (Textvorlage anpassen / Schadensmeldung)'}
  ],
  '4.2': [
    {id:'si-schriftlich-kom',label:'Schriftlich kommunizieren (Brief/E-Mail)'},
    {id:'si-inhalte-erfassen',label:'Inhalte (aus Berichten, Sach-/Fachtexten, Verträgen) erfassen'},
    {id:'si-zusammenhaenge', label:'Zusammenhänge umformulieren'},
    {id:'si-lesestrategien', label:'Strategien beim Lesen anwenden'},
    {id:'si-grafiken',       label:'Grafiken'}
  ],
  '4.3': [
    {id:'si-kommunikation',  label:'Kommunikationsformen (Rollenkonflikte lösen)'},
    {id:'si-ueberzeugen',    label:'Faktenbezogen überzeugen'},
    {id:'si-position',       label:'Position beziehen'}
  ],
  '4.4': [
    {id:'si-interview',      label:'Interview'},
    {id:'si-loesungsorient', label:'Lösungsorientiert kommunizieren'}
  ],
  '4.5': [
    {id:'si-lernstrategien', label:'Lernstrategien mit Sachstruktur reflektieren'},
    {id:'si-verhalten',      label:'Verhalten reflektieren'},
    {id:'si-einfluss-sprache',label:'Einfluss von Sprache reflektieren'}
  ],
  'normen': [
    {id:'si-gross-klein',    label:'Gross-/Kleinschreibung'},
    {id:'si-das-dass',       label:'das/dass'},
    {id:'si-formell',        label:'Formell (Register/Höflichkeit)'}
  ]
};

const SI_ALL = {};
Object.values(SPRACH_INHALTE).forEach(arr => arr.forEach(si => {
  SI_ALL[si.id] = si.label;
  if (si.id.startsWith('si-')) SI_ALL[si.id.replace('si-','')] = si.label;
}));

function aid(nr) {
  const p = nr.split('.')[0];
  if (p==='1') return 'sk-'+nr;
  if (p==='2') return 'ges-'+nr;
  if (p==='3') return 'dig-'+nr;
  if (p==='4') return 'spr-'+nr;
  return nr;
}
function mcat(id) {
  if (id.startsWith('sk-'))  return 'schluessel';
  if (id.startsWith('ges-')) return 'gesellschaft';
  if (id.startsWith('dig-')) return 'digital';
  if (id.startsWith('spr-')) return 'sprache';
  if (id.startsWith('si-'))  return 'sprach-inhalt';
  return '';
}
function sortNr(a,b) { const pa=a.split('.').map(Number),pb=b.split('.').map(Number); return pa[0]!==pb[0]?pa[0]-pb[0]:(pa[1]||0)-(pb[1]||0); }

/* ══════════════════════════════════════════
   PARSING
   ══════════════════════════════════════════ */

let themenData = {};
let activeFilter = null;
let openDropdown = null; // which dropdown is currently open

function parseThemaHTML(html, themeNr) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const skSet = new Set();
  doc.querySelectorAll('.kompetenz-nummer-link').forEach(el => {
    const t = el.textContent.trim();
    if (/^1\.\d+$/.test(t)) skSet.add(t);
  });

  const lebensbezuege = [];
  doc.querySelectorAll('.lebensbezug').forEach((lb) => {
    const hdr = lb.querySelector('.lebensbezug-header h3');
    let txt = '';
    if (hdr) txt = hdr.textContent.replace(/^\d+\.\s*Individueller Lebensbezug:\s*/i,'').trim();

    const komps = [];
    lb.querySelectorAll('.lerninhalt').forEach(li => {
      const te = li.querySelector('.kompetenz-header h4');
      const title = te ? te.textContent.trim() : '';
      const ges=new Set(), dig=new Set(), spr=new Set();
      li.querySelectorAll('.ges-tag').forEach(s => { const m=s.textContent.match(/^(2\.\d+)/); if(m) ges.add(m[1]); });
      li.querySelectorAll('.dig-tag').forEach(s => { const m=s.textContent.match(/^(3\.\d+)/); if(m) dig.add(m[1]); });
      li.querySelectorAll('.sprach-tag').forEach(s => { const m=s.textContent.match(/^(4\.\d+)/); if(m) spr.add(m[1]); });
      komps.push({ title, gesellschaft:[...ges].sort(sortNr), digital:[...dig].sort(sortNr), sprache:[...spr].sort(sortNr) });
    });
    lebensbezuege.push({ text:txt, kompetenzen:komps });
  });

  const fb = {gesellschaft:new Set(),digital:new Set(),sprache:new Set()};
  doc.querySelectorAll('.freibereich-content .ges-tag').forEach(s=>{const m=s.textContent.match(/^(2\.\d+)/);if(m)fb.gesellschaft.add(m[1]);});
  doc.querySelectorAll('.freibereich-content .dig-tag').forEach(s=>{const m=s.textContent.match(/^(3\.\d+)/);if(m)fb.digital.add(m[1]);});
  doc.querySelectorAll('.freibereich-content .sprach-tag').forEach(s=>{const m=s.textContent.match(/^(4\.\d+)/);if(m)fb.sprache.add(m[1]);});

  const siIds = new Set();
  doc.querySelectorAll('.zirk-tag[data-zirk]').forEach(el => { siIds.add(el.getAttribute('data-zirk')); });
  doc.querySelectorAll('.norm-tag[data-norm]').forEach(el => {
    const normId = el.getAttribute('data-norm');
    if (normId) siIds.add(normId.replace('norm-', 'si-'));
  });

  return {
    schluessel:[...skSet].sort(sortNr),
    lebensbezuege,
    freibereich:{gesellschaft:[...fb.gesellschaft].sort(sortNr),digital:[...fb.digital].sort(sortNr),sprache:[...fb.sprache].sort(sortNr)},
    sprachInhalte:[...siIds]
  };
}

/* ══════════════════════════════════════════
   DROPDOWN RENDERING
   ══════════════════════════════════════════ */

function renderDropdowns() {
  // Schlüsselkompetenzen
  const dsk = document.getElementById('dropdown-schluessel');
  const rowSk = document.createElement('div'); rowSk.className = 'dropdown-inner';
  rowSk.appendChild(makeChipReset('Alle Schlüsselkompetenzen anzeigen', 'schluessel', 'chip-schluessel'));
  Object.entries(SK).sort((a,b)=>sortNr(a[0],b[0])).forEach(([nr, text]) => {
    rowSk.appendChild(makeChip(nr+' '+text, aid(nr), 'chip-schluessel'));
  });
  dsk.appendChild(rowSk);

  // Gesellschaft
  const dges = document.getElementById('dropdown-gesellschaft');
  const rowGes = document.createElement('div'); rowGes.className = 'dropdown-inner';
  rowGes.appendChild(makeChipReset('Alle Aspekte anzeigen', 'gesellschaft', 'chip-gesellschaft'));
  Object.entries(GES).sort((a,b)=>sortNr(a[0],b[0])).forEach(([nr, text]) => {
    rowGes.appendChild(makeChip(nr+' '+text, aid(nr), 'chip-gesellschaft'));
  });
  dges.appendChild(rowGes);

  // Digital
  const ddig = document.getElementById('dropdown-digital');
  const rowDig = document.createElement('div'); rowDig.className = 'dropdown-inner';
  rowDig.appendChild(makeChipReset('Alle Kompetenzen anzeigen', 'digital', 'chip-digital'));
  Object.entries(DIG).sort((a,b)=>sortNr(a[0],b[0])).forEach(([nr, text]) => {
    rowDig.appendChild(makeChip(nr+' '+text, aid(nr), 'chip-digital'));
  });
  ddig.appendChild(rowDig);

  // Sprachtypen
  const dspr = document.getElementById('dropdown-sprache');
  const rowSpr = document.createElement('div'); rowSpr.className = 'dropdown-inner';
  rowSpr.appendChild(makeChipReset('Alle Sprachtypen anzeigen', 'sprache', 'chip-sprache'));
  Object.entries(SPR).sort((a,b)=>sortNr(a[0],b[0])).forEach(([nr, text]) => {
    rowSpr.appendChild(makeChip(nr+' '+text, aid(nr), 'chip-sprache'));
  });
  dspr.appendChild(rowSpr);

  // Sprachinhalte - grouped
  const dsi = document.getElementById('dropdown-sprach-inhalt');
  const siGroup = document.createElement('div'); siGroup.className = 'si-group';
  // "Alle" row at top
  const allSiRow = document.createElement('div'); allSiRow.className = 'si-group-row';
  allSiRow.appendChild(makeChipReset('Alle Sprachinhalte anzeigen', 'sprach-inhalt', 'chip-sprach-inhalt'));
  siGroup.appendChild(allSiRow);
  const sprKeys = Object.keys(SPRACH_INHALTE).filter(k=>k!=='normen').sort(sortNr);
  sprKeys.forEach(sprNr => {
    const lbl = document.createElement('div');
    lbl.className = 'si-group-header';
    lbl.textContent = sprNr + ' ' + (SPR[sprNr] || sprNr);
    siGroup.appendChild(lbl);
    const row = document.createElement('div'); row.className = 'si-group-row';
    SPRACH_INHALTE[sprNr].forEach(si => {
      row.appendChild(makeChip(si.label, si.id, 'chip-sprach-inhalt'));
    });
    siGroup.appendChild(row);
  });
  if (SPRACH_INHALTE['normen']) {
    const lbl = document.createElement('div');
    lbl.className = 'si-group-header si-norm-header';
    lbl.textContent = 'Normen / Konventionen / Sprachbewusstheit';
    siGroup.appendChild(lbl);
    const row = document.createElement('div'); row.className = 'si-group-row';
    SPRACH_INHALTE['normen'].forEach(si => {
      row.appendChild(makeChip(si.label, si.id, 'chip-sprach-inhalt'));
    });
    siGroup.appendChild(row);
  }
  dsi.appendChild(siGroup);
}

function makeChipReset(label, cat, chipClass) {
  const c = document.createElement('div');
  c.className = 'chip chip-reset ' + chipClass;
  c.textContent = '↺ ' + label;
  c.setAttribute('data-filter-cat', cat);
  c.onclick = () => filterCategory(cat, c);
  return c;
}

function filterCategory(cat, chipEl) {
  activeFilter = 'cat:' + cat;
  document.getElementById('btn-reset').classList.remove('active');
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  if (chipEl) chipEl.classList.add('active');

  // Show all badges of this category, hide others
  document.querySelectorAll('.kompetenz-badge').forEach(b => {
    b.style.display = b.getAttribute('data-category') === cat ? 'inline-block' : 'none';
  });
  document.querySelectorAll('.schluesselkompetenz-badge').forEach(b => {
    b.style.display = cat === 'schluessel' ? 'inline-block' : 'none';
  });
  document.querySelectorAll('.schluesselkompetenzen').forEach(sk => {
    sk.style.display = cat === 'schluessel' ? 'block' : 'none';
  });
  updateVis();
}

function makeChip(label, aspekt, chipClass) {
  const c = document.createElement('div');
  c.className = 'chip ' + chipClass;
  c.textContent = label;
  c.setAttribute('data-aspekt', aspekt);
  c.onclick = () => filterAspekt(aspekt, c);
  return c;
}

/* ══════════════════════════════════════════
   RENDERING TIMELINE
   ══════════════════════════════════════════ */

function renderTimeline() {
  const cont = document.getElementById('timeline-container');
  cont.innerHTML = '';
  const yNames = ['Grundlagen','Vertiefung','Transfer'];
  for (let y=1;y<=3;y++) {
    const col = document.createElement('div');
    col.className='year-column';
    col.innerHTML=`<div class="year-header"><h2>${y}. Lehrjahr</h2><p>${yNames[y-1]}</p></div>`;
    THEMES.filter(t=>t.year===y).forEach(theme => {
      if (theme.schlussarbeit) { col.appendChild(createSchlussarbeit()); return; }
      const data = themenData[theme.nr];
      col.appendChild(data ? createCard(theme,data) : createPlaceholder(theme));
    });
    cont.appendChild(col);
  }
}

function createSchlussarbeit() {
  const d=document.createElement('div');
  d.className='theme-card schlussarbeit';
  d.innerHTML='<h3>Schlussarbeit</h3><div class="lebensbezug-item"><span style="font-size:.8em;color:#666;">Gemäss Vorgaben im letzten Lehrjahr</span></div>';
  return d;
}

function createPlaceholder(theme) {
  const d=document.createElement('div');
  d.className='theme-card placeholder';
  d.innerHTML=`<h3>Thema ${theme.nr}: ${theme.name}</h3><div class="lebensbezug-item"><span style="font-size:.8em;color:#999;">Inhalte werden ergänzt</span></div>`;
  return d;
}

function mkBadge(text, cssClass, cat, aspekt, tooltipText) {
  const b=document.createElement('div');
  b.className=`kompetenz-badge ${cssClass}`;
  b.textContent=text;
  b.setAttribute('data-category',cat);
  b.setAttribute('data-aspekt',aspekt);
  const tt=document.createElement('div');tt.className='tooltip';tt.textContent=tooltipText;
  b.appendChild(tt);
  return b;
}

function createCard(theme, data) {
  const card=document.createElement('div');
  card.className='theme-card';
  const h3=document.createElement('h3');
  h3.textContent=`Thema ${theme.nr}: ${theme.name}`;
  card.appendChild(h3);

  if (data.schluessel.length) {
    const sd=document.createElement('div');sd.className='schluesselkompetenzen';
    data.schluessel.forEach(nr => {
      const b=document.createElement('div');b.className='schluesselkompetenz-badge';b.textContent=nr;
      b.setAttribute('data-category','schluessel');b.setAttribute('data-aspekt',aid(nr));
      const tt=document.createElement('div');tt.className='tooltip';tt.textContent=SK[nr]||nr;b.appendChild(tt);
      sd.appendChild(b);
    });
    card.appendChild(sd);
  }

  data.lebensbezuege.forEach((lb,idx) => {
    const item=document.createElement('div');item.className='lebensbezug-item';
    const label=document.createElement('span');label.className='lebensbezug-label';label.textContent=`Lebensbezug ${idx+1}`;label.style.position='relative';
    if(lb.text){const tt=document.createElement('div');tt.className='tooltip';tt.textContent=lb.text;label.appendChild(tt);}
    item.appendChild(label);

    const allG=new Set(),allD=new Set(),allS=new Set();
    lb.kompetenzen.forEach(k=>{k.gesellschaft.forEach(n=>allG.add(n));k.digital.forEach(n=>allD.add(n));k.sprache.forEach(n=>allS.add(n));});

    const kd=document.createElement('div');kd.className='kompetenz-detail';
    [...allG].sort(sortNr).forEach(nr=>kd.appendChild(mkBadge(nr,'badge-gesellschaft','gesellschaft',aid(nr),GES[nr]||nr)));
    [...allD].sort(sortNr).forEach(nr=>kd.appendChild(mkBadge(nr,'badge-digital','digital',aid(nr),DIG[nr]||nr)));
    [...allS].sort(sortNr).forEach(nr=>kd.appendChild(mkBadge(nr,'badge-sprache','sprache',aid(nr),SPR[nr]||nr)));

    item.appendChild(kd);card.appendChild(item);
  });

  if(data.sprachInhalte && data.sprachInhalte.length){
    const item=document.createElement('div');item.className='lebensbezug-item';
    const label=document.createElement('span');label.className='lebensbezug-label';label.textContent='Sprachinhalte (zirkulär)';label.style.position='relative';
    const tt=document.createElement('div');tt.className='tooltip';tt.textContent='Wiederkehrende sprachliche Handlungen';label.appendChild(tt);
    item.appendChild(label);
    const kd=document.createElement('div');kd.className='kompetenz-detail';
    data.sprachInhalte.sort().forEach(siId=>{
      const normalId = siId.startsWith('si-') ? siId : 'si-' + siId;
      const lbl = SI_ALL[siId] || SI_ALL[normalId] || siId;
      kd.appendChild(mkBadge(lbl,'badge-sprach-inhalt','sprach-inhalt',normalId,lbl));
    });
    item.appendChild(kd);card.appendChild(item);
  }

  return card;
}

/* ══════════════════════════════════════════
   FILTER LOGIC
   ══════════════════════════════════════════ */

function toggleDropdown(cat) {
  const panel = document.getElementById('dropdown-' + cat);
  const btn = document.getElementById('btn-' + cat);

  if (openDropdown === cat) {
    // Close this dropdown
    panel.classList.remove('visible');
    btn.classList.remove('open', 'active');
    openDropdown = null;
  } else {
    // Close any open dropdown
    if (openDropdown) {
      document.getElementById('dropdown-' + openDropdown).classList.remove('visible');
      document.getElementById('btn-' + openDropdown).classList.remove('open', 'active');
    }
    panel.classList.add('visible');
    btn.classList.add('open', 'active');
    openDropdown = cat;
  }
}

function filterAspekt(aspekt, chipEl) {
  // Toggle: clicking same chip resets
  if (activeFilter === aspekt) {
    resetFilter();
    return;
  }
  activeFilter = aspekt;
  document.getElementById('btn-reset').classList.remove('active');

  // Deactivate all chips, activate clicked
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  if (chipEl) chipEl.classList.add('active');

  // Show/hide badges
  document.querySelectorAll('.kompetenz-badge,.schluesselkompetenz-badge').forEach(b => {
    b.style.display = b.getAttribute('data-aspekt') === aspekt ? 'inline-block' : 'none';
  });
  document.querySelectorAll('.schluesselkompetenzen').forEach(sk => {
    const vis = [...sk.querySelectorAll('.schluesselkompetenz-badge')].some(b => b.style.display !== 'none');
    sk.style.display = vis ? 'block' : 'none';
  });
  updateVis();
}

function updateVis() {
  document.querySelectorAll('.lebensbezug-item').forEach(item => {
    const badges = item.querySelectorAll('.kompetenz-badge');
    const vis = [...badges].some(b => b.style.display !== 'none');
    item.style.display = vis ? 'block' : 'none';
  });
  document.querySelectorAll('.theme-card:not(.placeholder):not(.schlussarbeit)').forEach(card => {
    const items = [...card.querySelectorAll('.lebensbezug-item')].some(i => i.style.display !== 'none');
    const sk = card.querySelector('.schluesselkompetenzen');
    const skVis = sk && sk.style.display !== 'none';
    card.style.display = (items || skVis) ? 'block' : 'none';
  });
}

function resetFilter() {
  activeFilter = null;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.main-filter-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-reset').classList.add('active');
  // Close open dropdown
  if (openDropdown) {
    document.getElementById('dropdown-' + openDropdown).classList.remove('visible');
    document.getElementById('btn-' + openDropdown).classList.remove('open');
    openDropdown = null;
  }
  document.querySelectorAll('.kompetenz-badge,.schluesselkompetenz-badge').forEach(b => { b.style.display = 'inline-block'; });
  document.querySelectorAll('.schluesselkompetenzen').forEach(s => { s.style.display = 'block'; });
  document.querySelectorAll('.lebensbezug-item').forEach(i => { i.style.display = 'block'; });
  document.querySelectorAll('.theme-card').forEach(c => { c.style.display = 'block'; });
}

/* ══════════════════════════════════════════
   TOGGLES & LOAD
   ══════════════════════════════════════════ */

function toggleStatusInfo() {
  document.querySelector('.status-info-content').classList.toggle('open');
  document.querySelector('.status-info-toggle').classList.toggle('open');
}

async function loadData() {
  for (const theme of THEMES) {
    if (!theme.file) continue;
    try {
      const r = await fetch(theme.file);
      if (!r.ok) { console.warn(`${theme.file}: ${r.status}`); continue; }
      themenData[theme.nr] = parseThemaHTML(await r.text(), theme.nr);
    } catch(e) { console.warn(`Fehler ${theme.file}:`, e); }
  }
  renderDropdowns();
  renderTimeline();
  document.getElementById('loading').style.display = 'none';
  document.getElementById('timeline-container').style.display = 'flex';
  // Mark "Alles anzeigen" as active by default
  document.getElementById('btn-reset').classList.add('active');
}

document.addEventListener('DOMContentLoaded', loadData);
</script>

<footer>
  <div class="footer-inner">
    <span class="footer-copyright">© 2025 - Mittelschul- und Berufsbildungsamt Kanton Bern</span>
    <nav class="footer-links" aria-label="Footer-Navigation">
      <a href="../rechtliche-hinweise.html">Rechtliche Hinweise</a>
      <a href="../impressum_de.html">Impressum</a>
    </nav>
  </div>
</footer>

</body>
</html>
